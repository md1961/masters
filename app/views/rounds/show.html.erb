<div id="button_to_proceed">
  <%= form_tag round_path, method: :patch do %>
    <% if @round.needs_input? -%>
      <%= hidden_field_tag :choosing_next_use, 1 %>
      <% @round.current_group.next_player.ball.next_use_options.each_with_index do |option, index| -%>
        <%= radio_button_tag :shot_option, index %>
        <%= label_tag "shot_option_#{index}", option %>
      <% end -%>
      <br>
    <% end -%>
    <%= submit_tag :Proceed, disabled: @message %>
  <% end -%>
</div>

<table>
  <% group = @round.current_group
     player = group.try(:next_player) -%>
  <% if @round.ready_to_play? -%>
    <% if group.all_holed_out? -%>
      <%# TODO: Extract all of these to hole_result_display() %>
      <tr>
        <td colspan="5"><%= "#{group} holed out on #{player.shot.hole}" %></td>
      </tr>
      <%= hole_result_display(group) %>
      <% if player.shot.hole.number == @round.final_hole_number -%>
        <tr>
          <td><%= round_result_display(group) %></td>
        </tr>
      <% end -%>
    <% else -%>
      <% ball = player.ball -%>
      <tr>
        <td><%= player.shot.hole.full_desc(with_distance: true) %></td>
      </tr>
      <tr>
        <td class="italic"><%= pre_shot_display(player) %></td>
      </tr>
      <tr>
        <td class="italic"><%= ball.next_shot_display %></td>
      </tr>
    <% end -%>
  <% elsif @round.needs_input? -%>
    <tr>
      <td class="italic"><%= "#{player} on #{player.shot.hole} for #{player.shot} to choose shot" %></td>
    </tr>
  <% elsif @round.play_result -%>
    <% if @message -%>
      <div id="message" data-time_to_delay="<%= @time_to_delay %>">
        <%= @message %>
      </div>
    <% end -%>
    <% if @round.play_result =~ Group::RE_PLAYER_ID_AND_INFO -%>
      <%# TODO: Refactor this mess. %>
      <% player = Player.find(Regexp.last_match(1).to_i)
         club_used = Regexp.last_match(2)
         info = Regexp.last_match(3)
         ball = player.ball
         ball.club_used = player.clubs.find_by(name: club_used.downcase) -%>
      <tr class="delayed_display" <%= @message && 'hidden' %>>
        <td><%= player.shot.hole.full_desc %></td>
      </tr>
      <tr class="delayed_display" <%= @message && 'hidden' %>>
        <td><%= ball.result_display %></td>
      </tr>
      <tr class="delayed_display" <%= @message && 'hidden' %>>
        <% next_shot_display = ball.next_shot_display -%>
        <td class="smaller">
          <%= ball.holed_out? || next_shot_display.blank? ? nil : "( next will be: #{next_shot_display} )" %>
        </td>
      </tr>
      <tr class="delayed_display italic" <%= @message && 'hidden' %>>
        <td class="smaller italic"><%= info %></td>
      </tr>
    <% else -%>
      <tr class="delayed_display" <%= @message && 'hidden' %>>
        <td><%= @round.play_result %></td>
      </tr>
    <% end -%>
  <% else -%>
    <%= "Ready to play #{@round}" %>
  <% end -%>
</table>

<div id="players_info">
  <table>
    <% groups_for_players_info.each_with_index do |group, index_group| -%>
      <% group.players.each_with_index do |player, index| -%>
        <tr class="<%= index_group >= num_groups_in_players_info && 'not_to_display' %>">
          <% if index.zero? -%>
            <td rowspan="<%= group.players.size %>"
                class="<%= group == @round.group_to_display && 'current' %>">
              <%= group.number %>
            </td>
          <% end -%>
          <% ball = player.ball %>
          <% if ball.nil? -%>
            <td><%= player %></td>
          <% else -%>
            <% hole = player.shot.try(:hole)
               is_fin = ball.finished_round? -%>
            <td><%= player %></td>
            <td class="numeric"><%= score_formatted(player.tournament_score) %></td>
            <% if index.zero? -%>
              <td rowspan="<%= group.players.size %>" class="numeric">
                <%= hole.try(:full_desc) %>
              </td>
            <% end -%>
            <td class="emphasized"><%= is_fin ? nil : ball.shot_count %></td>
            <td><%= is_fin || player != group.next_player ? nil : 'n' %></td>
            <td><%= is_fin ? nil : ball.lands %></td>
            <% result = ball.result -%>
            <td class="<%= result && result.end_with?('*') && 'emphasized' %>">
              <%= is_fin ? 'FIN' : result %>
            </td>
            <td><%= ball.next_shot_display(true) %></td>
          <% end -%>
        </tr>
      <% end -%>
    <% end -%>
  </table>
  <span id="toggle_players_info_full_display" class="button">[ ... ]</span>
</div>

<% label_for_toggle_button = @style == 'pretty' ? '[-]' : '[+]' -%>

<div id="leader_board">
  <% if @style.blank? -%>
    <span id="toggle_leader_board_display" class="button"><%= label_for_toggle_button %></span>
  <% end -%>
  <table id="leaders" class="<%= @style.present? && 'table_base' %>" <%= @style.blank? && 'hidden' %>>
    <% @round.tournament.players.sort_by(&:leader_sorter).each_with_index do |player, index| -%>
      <tr class="<%= index >= num_players_in_leader_board && 'not_to_display' %>">
        <td><%= player %></td>
        <td class="numeric"><%= score_formatted(player.tournament_score) %></td>
        <td class="numeric"><%= player.hole_finished %></td>
      </tr>
    <% end -%>
  </table>
  <span id="toggle_leader_board_full_display" class="button">[ ... ]</span>
</div>

<% unless @round.groups.empty? -%>
  <div id="score_cards">
    <% if @style.blank? -%>
      <span class="hide_score_card_display button">[-]</span>
    <% end -%>
    <% @round.groups.each do |group| -%>
      <% is_current = group == @round.group_to_display -%>
      <span class="toggle_score_card_display button <%= is_current && 'current' %>">
        <%= group.number %>
      </span>
    <% end -%>
    <% @round.groups.each do |group| -%>
      <% group.players.each do |player| -%>
        <%= render player.score_cards.find_by(round: @round) %>
      <% end -%>
    <% end -%>
  </div>
<% end -%>

<div id="hole_map">
  <% if @style.blank? -%>
    <div>
      <span id="toggle_hole_map_display" class="button"><%= label_for_toggle_button %></span>
    </div>
  <% end -%>
  <% if hole = @round.group_to_display&.players&.first&.shot&.hole -%>
    <%= render hole %>
  <% end -%>
</div>
