<div id="button_to_proceed">
  <%= form_tag round_path, method: :patch do %>
    <% if @round.needs_input? -%>
      <%= hidden_field_tag :choosing_next_use, 1 %>
      <% @round.current_group.next_player.ball.next_use_options.each_with_index do |option, index| -%>
        <%= radio_button_tag :shot_option, index %><%= option %>
      <% end -%>
      <br>
    <% end -%>
    <%= submit_tag :Proceed, disabled: @message %>
  <% end -%>
</div>

<table>
  <% group = @round.current_group
     player = group.try(:next_player) -%>
  <% if @round.ready_to_play? -%>
    <% if group.all_holed_out? -%>
      <tr>
        <td><%= "#{group} holed out on #{player.shot.hole}" %></td>
      </tr>
      <tr>
        <td><%= hole_result_display(group) %></td>
      </tr>
      <% if player.shot.hole.number == @round.final_hole_number -%>
        <tr>
          <td><%= round_result_display(group) %></td>
        </tr>
      <% end -%>
    <% else -%>
      <% ball = player.ball -%>
      <tr>
        <td><%= "#{player} on #{area_display(player)} #{target_display(ball)}" %></td>
      </tr>
      <tr>
        <td><%= ball.next_shot_display %></td>
      </tr>
    <% end -%>
  <% elsif @round.needs_input? -%>
    <tr>
      <td><%= "#{player} on #{player.shot.hole} for #{player.shot} to choose shot" %></td>
    </tr>
  <% elsif @round.play_result -%>
    <% if @message -%>
      <div id="message"><%= @message %></div>
    <% end -%>
    <% eval(@round.play_result).each.with_index(1) do |line, line_no| -%>
      <tr class="delayed_display" <%= @message && 'hidden' %>>
        <td class="<%= line_no >= 3 && 'smaller' %> <%= line_no >= 4 && 'italic' %>">
          <%= line %>
        </td>
      </tr>
    <% end -%>
  <% else -%>
    <%= "Ready to play #{@round}" %>
  <% end -%>
</table>

<table id="players_info">
  <% @round.groups.each do |group| -%>
    <% group.players.each_with_index do |player, index| -%>
      <tr>
        <% if index.zero? -%>
          <td rowspan="<%= group.players.size %>"
              class="<%= group == @round.current_group && 'current' %>">
            <%= group.number %>
          </td>
        <% end -%>
        <% ball = player.ball %>
        <% if ball.nil? -%>
          <td><%= player %></td>
        <% else -%>
          <% hole = player.shot.try(:hole)
             is_fin = ball.finished_round? -%>
          <td><%= player %></td>
          <td class="numeric"><%= total_score_display(player, @round) %></td>
          <td class="numeric"><%= hole.try(:full_desc) %></td>
          <td class="emphasized"><%= is_fin ? nil : ball.shot_count %></td>
          <td><%= is_fin || player != group.next_player ? nil : 'n' %></td>
          <td><%= is_fin ? nil : ball.lands %></td>
          <% result = ball.result -%>
          <td class="<%= result && result.end_with?('*') && 'emphasized' %>">
            <%= is_fin ? 'FIN' : result %>
          </td>
          <td><%= ball.next_shot_display(true) %></td>
        <% end -%>
      </tr>
    <% end -%>
  <% end -%>
</table>

<% if group -%>
  <div id="score_cards">
    <span id="toggle_score_card_display" class="button">[+]</span>
    <% group.players.each do |player| -%>
      <%= render player.score_cards.find_by(round: @round) %>
    <% end -%>
  </div>
<% end -%>
